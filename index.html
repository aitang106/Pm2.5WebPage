<!DOCTYPE html>
<html class="background-dark" lang="en">
	<head>

		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1">
		
		<title>空氣污染預測</title>

		<!-- Loading third party fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700|" rel="stylesheet" type="text/css">
		<link href="fonts/font-awesome.min.css" rel="stylesheet" type="text/css">

		<!-- Loading main css file -->
		<link rel="stylesheet" href="style.css">
		
		<!--[if lt IE 9]>
		<script src="js/ie-support/html5.js"></script>
		<script src="js/ie-support/respond.js"></script>
		<![endif]-->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://www.w3counter.com/tracker.js?id=114477"></script>

        <script type="text/javascript" src="data.json"></script>


	</head>


	<body>

    <style>

        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
		
		<div class="site-content">
			<div class="site-header">
				<div class="container">
					<a href="index.html" class="branding">
						<img src="images/icons/wind-sign.svg" alt="" class="logo">
						<div class="logo-type">
							<h1 class="site-title">台灣空氣污染預測</h1>
							<small class="site-description">The Forecasting of PM2.5 in Taiwan</small>
						</div>
					</a>

				</div>
			</div> <!-- .site-header -->

            <p id="position_gps"></p>

			<div class="hero" data-bg-image="images/airpollution2.jpg">
				<div class="container">

                    <form action="#" class="find-location">
                        <input list="site-value-list" name="site-value-text" id="site-value-text" placeholder="選擇區域地點...">
                        <datalist class="site-value" id="site-value-list">

                        </datalist>
                        <input type="button" value="查詢" id="search-button">

                    </form>

				</div>
			</div>

			<main class="main-content">


                <div class="forecast-table">
                    <div class="container">
                        <div class="forecast-container">
                            <div class="today forecast">
                                <div class="forecast-header">
                                    <div class="day">PM2.5濃度指數</div>
                                    <div class="date">當前時間</div>
                                </div> <!-- .forecast-header -->
                                <div class="forecast-content">
                                    <div id="location" class="location"></div>
                                    <div class="degree">
                                        <div class="num">
                                            <span id="now-pm25" class="pm25-span"></span>
                                            <span class="pm25-unit-span">μg/m<sup>3</sup></span>
                                        </div>
                                        <div class="forecast-icon">
                                            <img id="now-icon-img" class="now-icon-img" src="" alt="" >
                                            <p id="now-value-status" class="now-value-status"></p>
                                            <div class="clearfix"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="forecast">
                                <div class="forecast-header">
                                    <div class="day">未來一小時</div>
                                </div> <!-- .forecast-header -->
                                <div class="forecast-content">
                                    <div class="degree padding-small">
                                        <div class="num">
                                            <span id="future-1hr-pm25" class="pm25-span"></span>
                                            <span class="pm25-unit-span">μg/m<sup>3</sup></span>
                                        </div>
                                    </div>
                                    <div class="forecast-icon">
                                        <img id="forecast-1hr-icon-img" class="forecast-icon-img" src="" alt="" >
                                        <span id="forecast-1hr-value-status" class="forecast-value-status"></span>
                                        <div class="clearfix"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="forecast">
                                <div class="forecast-header">
                                    <div class="day">未來3小時</div>
                                </div> <!-- .forecast-header -->
                                <div class="forecast-content">
                                    <div class="degree padding-small">
                                        <div class="num">
                                            <span id="future-3hr-pm25" class="pm25-span"></span>
                                            <span class="pm25-unit-span">μg/m<sup>3</sup></span>
                                        </div>
                                    </div>
                                    <div class="forecast-icon">
                                        <img id="forecast-3hr-icon-img" class="forecast-icon-img" src="" alt="" >
                                        <span id="forecast-3hr-value-status" class="forecast-value-status"></span>
                                        <div class="clearfix"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="forecast">
                                <div class="forecast-header">
                                    <div class="day">未來6小時</div>
                                </div> <!-- .forecast-header -->
                                <div class="forecast-content">
                                    <div class="degree padding-small">
                                        <div class="num">
                                            <span id="future-6hr-pm25" class="pm25-span"></span>
                                            <span class="pm25-unit-span">μg/m<sup>3</sup></span>
                                        </div>
                                    </div>
                                    <div class="forecast-icon">
                                        <img id="forecast-6hr-icon-img" class="forecast-icon-img" src="" alt="" >
                                        <span id="forecast-6hr-value-status" class="forecast-value-status"></span>
                                        <div class="clearfix"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="forecast">
                                <div class="forecast-header">
                                    <div class="day">未來12小時</div>
                                </div> <!-- .forecast-header -->
                                <div class="forecast-content">
                                    <div class="degree padding-small">
                                        <div class="num">
                                            <span id="future-12hr-pm25" class="pm25-span"></span>
                                            <span class="pm25-unit-span">μg/m<sup>3</sup></span>
                                        </div>
                                    </div>
                                    <div class="forecast-icon">
                                        <img id="forecast-12hr-icon-img" class="forecast-icon-img" src="" alt="" >
                                        <span id="forecast-12hr-value-status" class="forecast-value-status"></span>
                                        <div class="clearfix"></div>
                                    </div>
                                </div>
                            </div>
                            <!--<div class="forecast">-->
                                <!--<div class="forecast-header">-->
                                    <!--<div class="day">Saturday</div>-->
                                <!--</div> &lt;!&ndash; .forecast-header &ndash;&gt;-->
                                <!--<div class="forecast-content">-->
                                    <!--<div class="forecast-icon">-->
                                        <!--<img src="images/icons/icon-13.svg" alt="" width=48>-->
                                    <!--</div>-->
                                    <!--<div class="degree">23<sup>o</sup>C</div>-->
                                    <!--<small>18<sup>o</sup></small>-->
                                <!--</div>-->
                            <!--</div>-->
                            <!--<div class="forecast">-->
                                <!--<div class="forecast-header">-->
                                    <!--<div class="day">Sunday</div>-->
                                <!--</div> &lt;!&ndash; .forecast-header &ndash;&gt;-->
                                <!--<div class="forecast-content">-->
                                    <!--<div class="forecast-icon">-->
                                        <!--<img src="images/icons/icon-14.svg" alt="" width=48>-->
                                    <!--</div>-->
                                    <!--<div class="degree">23<sup>o</sup>C</div>-->
                                    <!--<small>18<sup>o</sup></small>-->
                                <!--</div>-->
                            <!--</div>-->
                        </div>
                    </div>
                </div>


                <div class="predict-button-box">

                    <div class="predict-button-title">
                        PM2.5濃度分佈圖
                    </div>

                    <div class="predict-button-content">

                        <div id="predict_0_hr" class="predict-button background-grey blue-border">當前時間</div>

                        <div id="predict_1_hr" class="predict-button background-dark-grey">未來1小時</div>

                        <div id="predict_3_hr" class="predict-button background-grey">未來3小時</div>

                        <div id="predict_6_hr" class="predict-button background-dark-grey">未來6小時</div>

                        <div id="predict_12_hr" class="predict-button background-grey">未來12小時</div>

                        <div class="clearfix"></div>
                    </div>



                </div>


                <div  id="map-box" class="map-box" style="position: relative;">
                        <img   id="map-img" src="https://cors.now.sh/http://220.134.52.177/img/map/basemap_color_now.png"  class="map-img" alt="">
                        <img   style="left:58%; top:7.7%;"id="point" src="point.png" class="point" alt="">
                  
                </div>
                

                <div class="map-range-box">

                    <img class="map-range-img" src="images/map/pm25rangeColor.png" alt="">
                    
                </div>


			</main> <!-- .main-content -->

			<footer class="site-footer">
				<div class="container">
					<div class="row">
						<!--<div class="col-md-8">-->
							<!--<form action="#" class="subscribe-form">-->
								<!--<input type="text" placeholder="Enter your email to subscribe...">-->
								<!--<input type="submit" value="Subscribe">-->
							<!--</form>-->
						<!--</div>-->
						<!--<div class="col-md-3 col-md-offset-1">-->
							<!--<div class="social-links">-->
								<!--<a href="#"><i class="fa fa-facebook"></i></a>-->
								<!--<a href="#"><i class="fa fa-twitter"></i></a>-->
								<!--<a href="#"><i class="fa fa-google-plus"></i></a>-->
								<!--<a href="#"><i class="fa fa-pinterest"></i></a>-->
							<!--</div>-->
						<!--</div>-->
					</div>

					<p class="colophon">Copyright © 2017 National Chung-Shan Institute of Science & Technology.</p>
				</div>
			</footer> <!-- .site-footer -->
		</div>

        <!--<script>-->


            <!--var map;-->
            <!--function initMap() {-->
                <!--map = new google.maps.Map(document.getElementById('map-box'), {-->
                    <!--center: {lat: 23.5, lng: 121},-->
                    <!--zoom: 8-->
                <!--});-->
            <!--}-->



        <!--</script>-->



        <script>

            $(".predict-button").click(function (event) {

                $(".predict-button").removeClass("blue-border");

                $(this).addClass("blue-border");



                var id_name = $(event.target).attr("id");

                var hr = id_name.split("_")[1];

                if(hr === '0') {
                    $("#map-img").attr("src", "https://cors.now.sh/http://220.134.52.177/img/map/basemap_color_now.png");
                }
                else {

                    $("#map-img").attr("src", "https://cors.now.sh/http://220.134.52.177/img/map/basemap_color_"+hr+"hr.png");
                }

                console.log(hr);

            });


            var siteArray = [];

            $( document ).ready(function() {

                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    url: "https://cors-anywhere.herokuapp.com/http://220.134.52.177:5000/getSites",
                    success: function (data) {
                        appendDataToDataList(data);
			updateSiteInfo('龍潭');
			setTimeout(function(){
				getLocation();
			},1000);
                    },
                    dataType: "json"
                });

                /*updateSiteInfo('龍潭');
                setTimeout(function(){
			getLocation();
		},1000);*/

                //updateSiteInfo(getLocation());

                //getLocation();
                //get_near_site();

            });


            function appendDataToDataList(data) {


                var sites = data['sites'];

                sites.forEach(function(site) {

                    $('#site-value-list').append($("<option>").attr('value', site));
                    siteArray.push(site);


                });


            }


            $("#search-button").click(function(){

                var inputSiteName = $("#site-value-text").val();
                var newInputSiteName = '';

                for(var i = 0; i < inputSiteName.length; i++ ) {

                    var ch = inputSiteName[i];
                    if(ch === '台') {
                        ch = '臺';
                    }
                    newInputSiteName += ch;
                }

                inputSiteName = newInputSiteName;


                if(inputSiteName === ''){
                    alert("請輸入測站地點");
                }
                else {

                    var maxSimilarity = 0;
                    var maxSimilarSite = '';

                    siteArray.forEach(function (sitename) {

                        var similarity = getSimilarity(sitename, inputSiteName);

                        if(similarity > maxSimilarity) {
                            maxSimilarity = similarity;
                            maxSimilarSite = sitename.split('-')[1];
                        }
                    });

                    siteArray.forEach(function (sitename) {

                        var siteOnlyName = sitename.split('-')[1];

                        if(sitename === inputSiteName || siteOnlyName === inputSiteName) {
                            maxSimilarSite = siteOnlyName;
                        }
                    });

                    if(maxSimilarSite === '') {
                        alert("無此測站error:1");
                    }
                    else {
                        updateSiteInfo(maxSimilarSite);
                    }

                }


            });

            function getSimilarity(sitename, inputSiteName) {

                var similarity = 0;
                for(var i = 0; i < inputSiteName.length; i++ ) {

                    var ch = inputSiteName[i];

                    if (sitename.indexOf(ch) > -1) {
                        similarity++;

                    }
                }

                return similarity;
            }


            function updateSiteInfo(siteName) {

                $.ajax({
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    url: "https://cors-anywhere.herokuapp.com/http://220.134.52.177:5000/getSitePrediction",
                    data: JSON.stringify({siteName: siteName}),
                    success: function (data) {
                        updatePrediction(data);
                    },
                    dataType: "json"
                });
            }

            function updatePrediction(data) {


                var county = data['County'];
                var siteName = data['SiteName'];

                var nowPM2_5 = data['PM2_5'];

                var predictPM2_5_1hr = data['predictPM2_5_1hr'];

                if(predictPM2_5_1hr === null || predictPM2_5_1hr === '0') {

                    predictPM2_5_1hr = nowPM2_5;

                }



                var predictPM2_5_3hr = data['predictPM2_5_3hr'];

                if(predictPM2_5_3hr === null || predictPM2_5_3hr === '0') {

                    predictPM2_5_3hr = nowPM2_5;

                }


                var predictPM2_5_6hr = data['predictPM2_5_6hr'];

                if(predictPM2_5_6hr === null || predictPM2_5_6hr === '0') {

                    predictPM2_5_6hr = nowPM2_5;

                }

                var predictPM2_5_12hr = data['predictPM2_5_12hr'];

                if(predictPM2_5_12hr === null || predictPM2_5_12hr === '0') {

                    predictPM2_5_12hr = nowPM2_5;

                }

                nowPM2_5 = parseInt(nowPM2_5);
                predictPM2_5_1hr = parseInt(predictPM2_5_1hr);
                predictPM2_5_3hr = parseInt(predictPM2_5_3hr);
                predictPM2_5_6hr = parseInt(predictPM2_5_6hr);
                predictPM2_5_12hr = parseInt(predictPM2_5_12hr);

                $("#location").text(county+siteName);
                $("#now-pm25").text(nowPM2_5);
                $("#future-1hr-pm25").text(predictPM2_5_1hr);
                $("#future-3hr-pm25").text(predictPM2_5_3hr);
                $("#future-6hr-pm25").text(predictPM2_5_6hr);
                $("#future-12hr-pm25").text(predictPM2_5_12hr);



                var nowStatusImage = getStatusFaceIcon(nowPM2_5);
                $("#now-icon-img").attr('src', nowStatusImage);
                $("#now-value-status").text(getPM25Status(nowPM2_5));


                var forecast1hrImage = getStatusFaceIcon(predictPM2_5_1hr);
                $("#forecast-1hr-icon-img").attr('src', forecast1hrImage);
                $("#forecast-1hr-value-status").text(getPM25Status(predictPM2_5_1hr));


                var forecast3hrImage = getStatusFaceIcon(predictPM2_5_3hr);
                $("#forecast-3hr-icon-img").attr('src', forecast3hrImage);
                $("#forecast-3hr-value-status").text(getPM25Status(predictPM2_5_3hr));


                var forecast6hrImage = getStatusFaceIcon(predictPM2_5_6hr);
                $("#forecast-6hr-icon-img").attr('src', forecast6hrImage);
                $("#forecast-6hr-value-status").text(getPM25Status(predictPM2_5_6hr));


                var forecast12hrImage = getStatusFaceIcon(predictPM2_5_12hr);
                $("#forecast-12hr-icon-img").attr('src', forecast12hrImage);
                $("#forecast-12hr-value-status").text(getPM25Status(predictPM2_5_12hr));

            }



            function getStatusFaceIcon(pm25Value) {

                var status = getPM25Status(pm25Value);
                var imgPath = getFaceIconMappingStatus(status);
                return imgPath;

            }

            function getPM25Status(pm25Value) {

                var rtn = "";

                if(pm25Value <= 35) {
                    rtn = "良好";
                }else if(pm25Value <= 53) {
                    rtn = "普通";
                }else if(pm25Value <= 70) {
                    rtn = "過量";
                }else {
                    rtn = "危險";
                }

                return rtn;

            }


            function getFaceIconMappingStatus(status) {


                var imgPath = "images/faceIcon/";

                if(status === '良好') {
                    imgPath += 'happy.svg';
                }else if(status === '普通') {
                    imgPath += 'calm.svg';
                }else if(status === '過量') {
                    imgPath += 'sad.svg';
                }else {
                    imgPath += 'nervous.svg';
                }

                return imgPath;

            }


            //劭雍改的
            var x = document.getElementById("position_gps");
            function getLocation() {
                if (navigator.geolocation) {
                   //navigator.geolocation.getCurrentPosition(showPosition);
                    navigator.geolocation.getCurrentPosition(get_near_site);
                } else {
                    x.innerHTML = "Geolocation is not supported by this browser.";
                }
            }
            function showPosition(position) {
                x.innerHTML = "Latitude: " + position.coords.latitude + 
                "<br>Longitude: " + position.coords.longitude; 
            }

            function get_near_site(position) { //計算最近位置
                var allsitelist = JSON.parse(data);
                var temp = 1000;
                var min = 1000;
                var minsite = "";
                for (var i = 0; i < allsitelist.length; i++) {
                    temp = Math.sqrt(Math.pow((parseFloat( position.coords.latitude ) - parseFloat(allsitelist[i].TWD97Lat)),2) + Math.pow((parseFloat( position.coords.longitude ) - parseFloat(allsitelist[i].TWD97Lon)),2));
                    if (temp < min ) {
                        min = temp ;
                        minsite = allsitelist[i].station;
                    }
                }

		//alert("gps"+position.coords.latitude+','+position.coords.longitude+'location:'+minsite);
                //------------------------------//
                var wei = $(window).width();
                
                if (  wei < 0 ) {
                    //var el = ((25.297436 - parseFloat( position.coords.latitude )) / 3.339367) *990 ;
                    //var dj0 = 700 -( ((120.288086- parseFloat(position.coords.longitude)) / 1.504842 ) *600);
                    $("#point").css('margin-left',dj0+'px' );
                    $("#point").css('margin-top',el+'px' );
                }

                else {
                    var el = 7.7 ;
                    var dj0 = 58 ;
                    var el = ((25.350149 - parseFloat( position.coords.latitude )) / 3.53) * 100 -6 ;
                    var dj0 =( (( parseFloat(position.coords.longitude ) -119.872162 ) / 2.21 ) ) *98 -5 ;
                    $("#point").css('left',dj0+'%' );
                    $("#point").css('top',el+'%' );
                }
                //----------------------------//
                var inputSiteName = String(minsite);
                var newInputSiteName = '';

                for(var i = 0; i < inputSiteName.length; i++ ) {

                    var ch = inputSiteName[i];
                    if(ch === '台') {
                        ch = '臺';
                    }
                    newInputSiteName += ch;
                }

                inputSiteName = newInputSiteName;


                if(inputSiteName === ''){
                    alert("請輸入測站地點");
                }
                else {

                    var maxSimilarity = 0;
                    var maxSimilarSite = '';
		    //alert('siteArray:'+siteArray);
		    //alert('inputSiteName:'+inputSiteName);
                    siteArray.forEach(function (sitename) {

                        var similarity = getSimilarity(sitename, inputSiteName);

                        if(similarity > maxSimilarity) {
                            maxSimilarity = similarity;
                            maxSimilarSite = sitename.split('-')[1];
                        }
                    });
		    
                    siteArray.forEach(function (sitename) {

                        var siteOnlyName = sitename.split('-')[1];
			console.log(sitename);
			console.log(inputSiteName);
			console.log(siteOnlyName);
                        if(sitename === inputSiteName || siteOnlyName === inputSiteName) {
                            maxSimilarSite = siteOnlyName;
			    //alert('in');
			    updateSiteInfo(maxSimilarSite);

                        }
                    });

                    /*if(maxSimilarSite === '') {
                        alert("無此測站Warning:2");
                    }
                    else {
                        updateSiteInfo(maxSimilarSite);
                    }*/

                }
            }
            //劭雍改的

        </script>


        <!--<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwwuA1WyM_4EBbeGkXL88ESckbhNSKlds&callback=initMap"-->
                <!--async defer></script>-->


        <script src="js/plugins.js"></script>
        <script src="js/app.js"></script>
        <script src="js/map.js"></script>
		
	</body>

</html>
